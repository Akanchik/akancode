<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>AKANCODE Онлайн</title>
  <style>
    body {
      font-family: monospace;
      background: #1e1e1e;
      color: #cfcfcf;
      margin: 20px;
    }
    .editor-wrapper {
      position: relative;
      width: 100%;
    }
    #highlight {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 180px;
      background: #2d2d2d;
      color: #eee;
      padding: 10px;
      font-size: 16px;
      line-height: 1.4em;
      white-space: pre-wrap;
      border: none;
      border-radius: 3px;
      pointer-events: none;
      overflow-y: auto;
    }
    textarea {
      position: relative;
      width: 100%;
      height: 180px;
      background: transparent;
      color: transparent;
      caret-color: white;
      border: none;
      padding: 10px;
      font-size: 16px;
      resize: vertical;
      font-family: monospace;
      line-height: 1.4em;
      overflow-y: auto;
    }
    /* Цвета подсветки */
    .string { color: #ce9178; }
    .number { color: #4FC1FF; }
    .arg { color: coral; }
    button {
      margin: 5px 5px 5px 0;
      padding: 8px 16px;
      font-size: 14px;
      background: #e69138;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #e48a2c;
    }
    .menu-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #333;
      min-width: 120px;
      z-index: 1;
      border: 1px solid #555;
    }
    .dropdown-content button {
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      color: white;
      padding: 8px;
      cursor: pointer;
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
    #output {
      white-space: pre-wrap;
      margin-top: 15px;
      background: #111;
      padding: 10px;
      min-height: 100px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <h1>AKANCODE</h1>

  <div class="menu-bar">
    <div class="dropdown">
      <button>Файл</button>
      <div class="dropdown-content">
        <button onclick="saveFile()">Сохранить</button>
        <button onclick="loadFile()">Загрузить</button>
        <input type="file" id="fileInput" style="display:none" onchange="handleFile(this.files)" />
      </div>
    </div>
    <button onclick="clearCode()">Очистить код</button>
    <button onclick="clearOutput()">Очистить вывод</button>
    <button onclick="showHelp()">Список команд</button>
  </div>

  <div class="editor-wrapper">
    <pre id="highlight"></pre>
    <textarea id="code" spellcheck="false"></textarea>
  </div>
  <br>
  <button onclick="runCode()">Запустить</button>
  <button onclick="openAsSite()">Открыть как сайт</button>
  <h5>V0.1.3 BETA</h5>

  <div id="output"></div>
  <div id="ui" style="margin-top: 20px;"></div>

<script>
const outputDiv = document.getElementById("output");
const fileInput = document.getElementById("fileInput");
const uiDiv = document.getElementById("ui");
let кнопкиНажаты = {};

// Очистка
function clearCode() {
  document.getElementById("code").value = "";
  updateHighlight();
}
function clearOutput() {
  outputDiv.innerHTML = "";
  uiDiv.innerHTML = "";
  кнопкиНажаты = {};
}

// Подсказка по командам
function showHelp() {
  alert(`Доступные команды AKANCODE:
ВВОД имя
ПРИСВОИТЬ имя = значение
СЛОЖИТЬ a b результат
ВЫЧЕСТЬ a b результат
УМНОЖИТЬ a b результат
ДЕЛИТЬ a b результат
СЛУЧАЙНО a b результат
ВЫВЕСТИ выражение
ПЕЧАТАТЬ "текст" или переменная
ЕСЛИ a > b ТО команда
ИГРА УГАДАЙ
ЗАГОЛОВОК "текст"
ТЕКСТ "текст"
КНОПКА имя "текст"
ЕСЛИ_НАЖАТА имя ТО команда
МЕТКА имя
ПЕРЕЙТИ имя`);
}

// Сохранение и загрузка
function saveFile() {
  const blob = new Blob([document.getElementById("code").value], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "script.ak";
  a.click();
}
function loadFile() {
  fileInput.click();
}
function handleFile(files) {
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById("code").value = e.target.result;
    updateHighlight();
  };
  reader.readAsText(files[0]);
}

// Печать по буквам
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
async function печать_по_буквам(text, delay = 100) {
  for (let i = 0; i < text.length; i++) {
    outputDiv.innerHTML += text[i];
    await sleep(delay);
  }
  outputDiv.innerHTML += "<br>";
}

// Подсветка команд
function highlightCommand(line) {
  if (!line.trim()) return "";

  const parts = line.split(" ");
  const cmd = parts[0].toUpperCase();
  let args = parts.slice(1).join(" ");

  // строки
  args = args.replace(/"[^"]*"/g, m => `<span class="string">${m}</span>`);
  // числа
  args = args.replace(/\b\d+\b/g, m => `<span class="number">${m}</span>`);
  // остальные аргументы
  args = args.replace(/\b[A-ZА-Я_][A-ZА-Я0-9_]*\b/gi, m => `<span class="arg">${m}</span>`);

  let cmdColor = "#FFD700"; // по умолчанию
  switch (cmd) {
    case "ВВОД": cmdColor = "#1E90FF"; break;
    case "ПРИСВОИТЬ": cmdColor = "#ADFF2F"; break;
    case "СЛОЖИТЬ": cmdColor = "#FF69B4"; break;
    case "ВЫЧЕСТЬ": cmdColor = "#FF4500"; break;
    case "УМНОЖИТЬ": cmdColor = "#00CED1"; break;
    case "ДЕЛИТЬ": cmdColor = "#BA55D3"; break;
    case "СЛУЧАЙНО": cmdColor = "#FF8C00"; break;
    case "ВЫВЕСТИ": cmdColor = "#7FFF00"; break;
    case "ПЕЧАТАТЬ": cmdColor = "#00FF7F"; break;
    case "ЕСЛИ": cmdColor = "#FF0000"; break;
    case "ИГРА": cmdColor = "#00BFFF"; break;
    case "ЗАГОЛОВОК": cmdColor = "#FF6347"; break;
    case "ТЕКСТ": cmdColor = "#FFA500"; break;
    case "КНОПКА": cmdColor = "#32CD32"; break;
    case "МЕТКА": cmdColor = "#8A2BE2"; break;
    case "ПЕРЕЙТИ": cmdColor = "#20B2AA"; break;
  }

  return `<span style="color:${cmdColor}">${cmd}</span> ${args}`;
}

// Обновление подсветки
function updateHighlight() {
  const code = document.getElementById("code").value;
  document.getElementById("highlight").innerHTML = code.split("\n").map(highlightCommand).join("\n");
}
document.getElementById("code").addEventListener("input", updateHighlight);
document.getElementById("code").addEventListener("scroll", () => {
  document.getElementById("highlight").scrollTop = document.getElementById("code").scrollTop;
});
updateHighlight();

// --- Исполнение кода ---
async function runCode() {
  outputDiv.innerHTML = "";
  uiDiv.innerHTML = "";
  кнопкиНажаты = {};
  const rawCode = document.getElementById("code").value.split("\n");
  let variables = {};
  let i = 0;

  const labels = {};
  for (let idx = 0; idx < rawCode.length; idx++) {
    let l = rawCode[idx].trim().toUpperCase();
    if (l.startsWith("МЕТКА ")) {
      let labelName = l.split(" ")[1];
      labels[labelName] = idx;
    }
  }

  while (i < rawCode.length) {
    let line = rawCode[i].trim();
    if (!line || line.startsWith("#")) { i++; continue; }

    const parts = line.split(" ");
    const cmd = parts[0].toUpperCase();

    try {
      if (cmd === "ВЫВЕСТИ") {
        let expr = parts.slice(1).join(" ");
        let val = variables[expr] ?? expr;
        outputDiv.innerHTML += val + "<br>";
      } else if (cmd === "ПЕЧАТАТЬ") {
        let text = parts.slice(1).join(" ");
        if (text.startsWith('"') && text.endsWith('"')) {
          await печать_по_буквам(text.slice(1, -1));
        } else {
          let val = variables[text] ?? text;
          await печать_по_буквам(val);
        }
      } else if (cmd === "ЗАГОЛОВОК") {
        let text = line.slice("ЗАГОЛОВОК".length).trim().replace(/^"|"$/g, "");
        uiDiv.innerHTML += `<h2>${text}</h2>`;
      } else if (cmd === "ТЕКСТ") {
        let text = line.slice("ТЕКСТ".length).trim().replace(/^"|"$/g, "");
        uiDiv.innerHTML += `<p>${text}</p>`;
      } else if (cmd === "КНОПКА") {
        let name = parts[1];
        let text = line.split('"').slice(1,2)[0];
        let btn = document.createElement("button");
        btn.textContent = text;
        btn.onclick = () => { кнопкиНажаты[name] = true; };
        uiDiv.appendChild(btn);
      } else if (cmd === "ПЕРЕЙТИ") {
        let labelName = parts[1];
        if (labels[labelName] !== undefined) {
          i = labels[labelName];
          continue;
        } else {
          outputDiv.innerHTML += `[Ошибка: метка '${labelName}' не найдена]<br>`;
        }
      }
    } catch (e) {
      outputDiv.innerHTML += `[Ошибка: ${e.message}]<br>`;
    }
    i++;
  }
}

// --- Открыть как сайт ---
async function openAsSite() {
  uiDiv.innerHTML = "";
  outputDiv.innerHTML = "";
  кнопкиНажаты = {};
  const rawCode = document.getElementById("code").value.split("\n");
  let i = 0;

  const labels = {};
  for (let idx = 0; idx < rawCode.length; idx++) {
    let l = rawCode[idx].trim().toUpperCase();
    if (l.startsWith("МЕТКА ")) {
      let labelName = l.split(" ")[1];
      labels[labelName] = idx;
    }
  }

  while (i < rawCode.length) {
    let line = rawCode[i].trim();
    if (!line || line.startsWith("#")) { i++; continue; }

    const parts = line.split(" ");
    const cmd = parts[0].toUpperCase();

    try {
      if (cmd === "ВЫВЕСТИ") {
        let expr = parts.slice(1).join(" ");
        outputDiv.innerHTML += expr + "<br>";
      } else if (cmd === "ЗАГОЛОВОК") {
        let text = line.slice("ЗАГОЛОВОК".length).trim().replace(/^"|"$/g, "");
        uiDiv.innerHTML += `<h2>${text}</h2>`;
      } else if (cmd === "ТЕКСТ") {
        let text = line.slice("ТЕКСТ".length).trim().replace(/^"|"$/g, "");
        uiDiv.innerHTML += `<p>${text}</p>`;
      } else if (cmd === "КНОПКА") {
        let name = parts[1];
        let text = line.split('"').slice(1,2)[0];
        let btn = document.createElement("button");
        btn.textContent = text;
        btn.onclick = () => { кнопкиНажаты[name] = true; };
        uiDiv.appendChild(btn);
      } else if (cmd === "ПЕРЕЙТИ") {
        let labelName = parts[1];
        if (labels[labelName] !== undefined) {
          i = labels[labelName];
          continue;
        } else {
          outputDiv.innerHTML += `[Ошибка: метка '${labelName}' не найдена]<br>`;
        }
      }
    } catch (e) {
      outputDiv.innerHTML += `[Ошибка: ${e.message}]<br>`;
    }
    i++;
  }
}
</script>

</body>
</html>
