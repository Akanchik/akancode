<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>AKANCODE Онлайн</title>
  <style>
    body {
      font-family: monospace;
      background: #1e1e1e;
      color: #cfcfcf;
      margin: 20px;
    }
    textarea {
      width: 100%;
      height: 180px;
      background: #2d2d2d;
      color: #eee;
      border: none;
      padding: 10px;
      font-size: 16px;
    }
    #output {
      white-space: pre-wrap;
      margin-top: 15px;
      background: #111;
      padding: 10px;
      min-height: 100px;
      border-radius: 5px;
    }
    button {
      margin: 5px 5px 5px 0;
      padding: 8px 16px;
      font-size: 14px;
      font-family: inherit;
      background: #007acc;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #005a9e;
    }
    .menu-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #333;
      min-width: 120px;
      z-index: 1;
      border: 1px solid #555;
    }
    .dropdown-content button {
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      color: white;
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
  </style>
</head>
<body>

  <h2>AKANCODE Онлайн V0.1.1 БЕТА</h2>

  <div class="menu-bar">
    <div class="dropdown">
      <button>Файл</button>
      <div class="dropdown-content">
        <button onclick="saveFile()">Сохранить</button>
        <button onclick="loadFile()">Загрузить</button>
        <input type="file" id="fileInput" style="display:none" onchange="handleFile(this.files)" />
      </div>
    </div>
    <button onclick="clearCode()">Очистить код</button>
    <button onclick="clearOutput()">Очистить вывод</button>
    <button onclick="showHelp()">Список команд</button>
  </div>

  <textarea id="code" spellcheck="false"></textarea>

  <div style="margin-top: 10px;">
    <button onclick="runCode()">Запустить</button>
    <button onclick="openAsSite()">Открыть как сайт</button>
  </div>

  <div id="output"></div>

<script>
const outputDiv = document.getElementById("output");
const fileInput = document.getElementById("fileInput");

function clearCode() {
  document.getElementById("code").value = "";
}
function clearOutput() {
  outputDiv.innerHTML = "";
}
function showHelp() {
  alert(`Доступные команды AKANCODE:
ВВОД имя
ПРИСВОИТЬ имя = значение
СЛОЖИТЬ a b результат
ВЫЧЕСТЬ a b результат
УМНОЖИТЬ a b результат
ДЕЛИТЬ a b результат
СЛУЧАЙНО a b результат
ВЫВЕСТИ выражение
ПЕЧАТАТЬ "текст" или переменная
ЕСЛИ a > b ТО команда
ИГРА УГАДАЙ
ЗАГОЛОВОК "текст"
ТЕКСТ "текст"
КНОПКА имя "текст"
ЕСЛИ КНОПКА имя НАЖАТА ТО команда`);
}
function saveFile() {
  const blob = new Blob([document.getElementById("code").value], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "script.ak";
  a.click();
}
function loadFile() {
  fileInput.click();
}
function handleFile(files) {
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById("code").value = e.target.result;
  };
  reader.readAsText(files[0]);
}
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
async function печать_по_буквам(text, delay = 100) {
  for (let i = 0; i < text.length; i++) {
    outputDiv.innerHTML += text[i];
    await sleep(delay);
  }
  outputDiv.innerHTML += "<br>";
}
async function runCommands(codeLines, target) {
  const variables = {};
  const кнопки = {};

  let i = 0;
  while (i < codeLines.length) {
    let line = codeLines[i].trim();
    if (!line || line.startsWith("#")) {
      i++;
      continue;
    }
    const parts = line.split(" ");
    const cmd = parts[0];

    try {
      if (cmd === "ВВОД") {
        const varName = parts[1];
        let val = prompt(`Введите значение для ${varName}:`);
        val = isNaN(parseInt(val)) ? val : parseInt(val);
        variables[varName] = val;
      } else if (cmd === "ПРИСВОИТЬ" && parts[2] === "=") {
        const name = parts[1];
        const val = parts[3];
        variables[name] = isNaN(val) ? (variables[val] ?? val) : parseInt(val);
      } else if (cmd === "СЛОЖИТЬ") {
        const result = parts.pop();
        let total = 0;
        for (let p of parts.slice(1)) total += parseInt(variables[p] ?? 0);
        variables[result] = total;
      } else if (cmd === "ВЫЧЕСТЬ") {
        variables[parts[3]] = parseInt(variables[parts[1]] ?? 0) - parseInt(variables[parts[2]] ?? 0);
      } else if (cmd === "УМНОЖИТЬ") {
        variables[parts[3]] = parseInt(variables[parts[1]] ?? 0) * parseInt(variables[parts[2]] ?? 0);
      } else if (cmd === "ДЕЛИТЬ") {
        const a = parseInt(variables[parts[1]] ?? 0);
        const b = parseInt(variables[parts[2]] ?? 1);
        variables[parts[3]] = b !== 0 ? a / b : "Ошибка: деление на 0";
      } else if (cmd === "СЛУЧАЙНО") {
        const a = parseInt(variables[parts[1]] ?? parts[1]);
        const b = parseInt(variables[parts[2]] ?? parts[2]);
        variables[parts[3]] = Math.floor(Math.random() * (b - a + 1)) + a;
      } else if (cmd === "ВЫВЕСТИ") {
        const expr = parts.slice(1).join(" ");
        let text = expr.includes("+")
          ? expr.split("+").map(p => (variables[p.trim()] ?? p.trim().replace(/"/g, ""))).join("")
          : (variables[expr] ?? expr.replace(/"/g, ""));
        target.innerHTML += text + "<br>";
      } else if (cmd === "ПЕЧАТАТЬ") {
        let text = parts.slice(1).join(" ");
        if (text.startsWith('"') && text.endsWith('"'))
          await печать_по_буквам(text.slice(1, -1));
        else
          await печать_по_буквам(String(variables[text] ?? `[ОШИБКА: переменная '${text}' не найдена]`));
      } else if (cmd === "ЕСЛИ") {
        const condIndex = parts.indexOf("ТО");
        const [leftRaw, op, rightRaw] = parts.slice(1, condIndex);
        const command = parts.slice(condIndex + 1).join(" ");
        const left = isNaN(leftRaw) ? (variables[leftRaw] ?? leftRaw) : parseFloat(leftRaw);
        const right = isNaN(rightRaw) ? (variables[rightRaw] ?? rightRaw) : parseFloat(rightRaw);
        let result = false;
        if (op === "=") result = left == right;
        else if (op === ">") result = left > right;
        else if (op === "<") result = left < right;
        if (result) codeLines.splice(i + 1, 0, command);
      } else if (cmd === "ИГРА" && parts[1] === "УГАДАЙ") {
        const число = Math.floor(Math.random() * 10) + 1;
        let попытки = 3;
        while (попытки-- > 0) {
          let guess = prompt("Угадай число от 1 до 10:");
          if (guess === null) break;
          guess = parseInt(guess);
          if (guess === число) return alert("Правильно! Ты угадал!");
          alert(guess < число ? "Больше!" : "Меньше!");
        }
        alert(`Ты проиграл! Число было ${число}`);
      } else if (cmd === "ЗАГОЛОВОК") {
        const text = line.match(/"(.+?)"/)?.[1];
        const h = document.createElement("h1");
        h.innerText = text;
        target.appendChild(h);
      } else if (cmd === "ТЕКСТ") {
        const text = line.match(/"(.+?)"/)?.[1];
        const p = document.createElement("p");
        p.innerText = text;
        target.appendChild(p);
      } else if (cmd === "КНОПКА") {
        const name = parts[1];
        const label = line.match(/"(.+?)"/)?.[1];
        const btn = document.createElement("button");
        btn.innerText = label;
        btn.onclick = () => {
          variables[`КНОПКА_${name}_НАЖАТА`] = true;
        };
        кнопки[name] = btn;
        target.appendChild(btn);
        target.appendChild(document.createElement("br"));
      } else if (cmd === "ЕСЛИ" && parts[1] === "КНОПКА" && parts[3] === "НАЖАТА" && parts[4] === "ТО") {
        const btnName = parts[2];
        const command = parts.slice(5).join(" ");
        if (variables[`КНОПКА_${btnName}_НАЖАТА`]) codeLines.splice(i + 1, 0, command);
      }
    } catch (e) {
      target.innerHTML += "Ошибка: " + e.message + "<br>";
    }

    i++;
  }
}

async function runCode() {
  outputDiv.innerHTML = "";
  const code = document.getElementById("code").value.toUpperCase().split("\n");
  await runCommands(code, outputDiv);
}

function openAsSite() {
  const newWin = window.open();
  const html = `
    <html><head><title>AKANCODE сайт</title></head><body style="font-family: monospace; background:#111; color:white; padding:20px;"><div id="site"></div>
    <script>
      const target = document.getElementById("site");
      (${runCommands.toString()})
      const code = \`${document.getElementById("code").value.toUpperCase()}\`.split("\\n");
      runCommands(code, target);
    </script>
    </body></html>`;
  newWin.document.write(html);
  newWin.document.close();
}
</script>

</body>
</html>