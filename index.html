<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>AKANCODE Онлайн</title>
  <style>
    body {
      font-family: monospace;
      background: #1e1e1e;
      color: #cfcfcf;
      margin: 20px;
    }
    textarea {
      width: 100%;
      height: 180px;
      background: #2d2d2d;
      color: #eee;
      border: none;
      padding: 10px;
      font-size: 16px;
    }
    #output {
      white-space: pre-wrap;
      margin-top: 15px;
      background: #111;
      padding: 10px;
      min-height: 100px;
      border-radius: 5px;
    }
    button {
      margin: 5px 5px 5px 0;
      padding: 8px 16px;
      font-size: 14px;
      background: #007acc;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-family: sans-serif;
    }
    button:hover {
      background: #005a9e;
    }
    .menu-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #333;
      min-width: 120px;
      z-index: 1;
      border: 1px solid #555;
    }
    .dropdown-content button {
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      color: white;
      font-family: sans-serif;
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
  </style>
</head>
<body>

<h2>AKANCODE Онлайн V0.1.4</h2>

<div class="menu-bar">
  <div class="dropdown">
    <button>Файл</button>
    <div class="dropdown-content">
      <button onclick="saveFile()">Сохранить</button>
      <button onclick="loadFile()">Загрузить</button>
      <input type="file" id="fileInput" style="display:none" onchange="handleFile(this.files)" />
    </div>
  </div>
  <button onclick="clearCode()">Очистить код</button>
  <button onclick="clearOutput()">Очистить вывод</button>
  <button onclick="showHelp()">Список команд</button>
</div>

<textarea id="code" spellcheck="false"></textarea>
<br>
<button onclick="runCode()">Запустить</button>
<button onclick="openAsSite()">Открыть как сайт</button>

<div id="output"></div>

<script>
const outputDiv = document.getElementById("output");
const fileInput = document.getElementById("fileInput");

function clearCode() {
  document.getElementById("code").value = "";
}

function clearOutput() {
  outputDiv.innerHTML = "";
}

function showHelp() {
  alert(`Доступные команды AKANCODE:
ВВОД имя
ПРИСВОИТЬ имя = значение
СЛОЖИТЬ a b результат
ВЫЧЕСТЬ a b результат
УМНОЖИТЬ a b результат
ДЕЛИТЬ a b результат
СЛУЧАЙНО a b результат
ВЫВЕСТИ выражение
ПЕЧАТАТЬ "текст" или переменная
ЕСЛИ a > b ТО команда
ИГРА УГАДАЙ
ЗАГОЛОВОК "текст"
ТЕКСТ "текст"
КНОПКА "название"
ЕСЛИ КНОПКА НАЖАТА "название" ТО команда`);
}

function saveFile() {
  const blob = new Blob([document.getElementById("code").value], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "script.ak";
  a.click();
}

function loadFile() {
  fileInput.click();
}

function handleFile(files) {
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById("code").value = e.target.result;
  };
  reader.readAsText(files[0]);
}

function escapeHtml(text) {
  return text.replace(/[&<>"']/g, m => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
  }[m]));
}

function openAsSite() {
  const code = document.getElementById("code").value;
  const win = window.open();
  const script = `
    <script>
    let variables = {};
    let buttonStates = {};
    let outputDiv = document.createElement('div');
    document.body.appendChild(outputDiv);
    outputDiv.style.fontFamily = 'monospace';

    function renderLine(line) {
      const parts = line.trim().split(" ");
      const cmd = parts[0];

      if (!cmd || cmd.startsWith("#")) return;

      if (cmd === "ЗАГОЛОВОК") {
        let text = line.slice(10).replace(/^"|"$/g, "");
        let h = document.createElement("h1");
        h.textContent = text;
        document.body.appendChild(h);
      } else if (cmd === "ТЕКСТ") {
        let text = line.slice(6).replace(/^"|"$/g, "");
        let p = document.createElement("p");
        p.textContent = text;
        document.body.appendChild(p);
      } else if (cmd === "КНОПКА") {
        let label = line.slice(7).replace(/^"|"$/g, "");
        let btn = document.createElement("button");
        btn.textContent = label;
        btn.style.margin = "5px";
        btn.onclick = () => { buttonStates[label] = true; runCode(); };
        document.body.appendChild(btn);
      } else if (cmd === "ЕСЛИ" && parts[1] === "КНОПКА" && parts[2] === "НАЖАТА") {
        let label = parts[3].replace(/^"|"$/g, "");
        if (buttonStates[label]) {
          let command = parts.slice(5).join(" ");
          renderLine(command);
          buttonStates[label] = false;
        }
      } else {
        try {
          if (cmd === "ПРИСВОИТЬ") {
            if (parts[2] === "=") {
              let val = parts[3];
              val = isNaN(val) ? (variables[val] ?? val) : parseFloat(val);
              variables[parts[1]] = val;
            }
          } else if (cmd === "ВЫВЕСТИ") {
            let expr = parts.slice(1).join(" ");
            let out = expr.replace(/^"|"$/g, "").replace(/\+ ?/g, "").split(" ").map(w =>
              variables[w] ?? w
            ).join(" ");
            outputDiv.innerHTML += escapeHtml(out) + "<br>";
          } else if (cmd === "СЛОЖИТЬ") {
            variables[parts[3]] = parseFloat(variables[parts[1]] ?? 0) + parseFloat(variables[parts[2]] ?? 0);
          } else if (cmd === "ВЫЧЕСТЬ") {
            variables[parts[3]] = parseFloat(variables[parts[1]] ?? 0) - parseFloat(variables[parts[2]] ?? 0);
          } else if (cmd === "УМНОЖИТЬ") {
            variables[parts[3]] = parseFloat(variables[parts[1]] ?? 0) * parseFloat(variables[parts[2]] ?? 0);
          } else if (cmd === "ДЕЛИТЬ") {
            let a = parseFloat(variables[parts[1]] ?? 0);
            let b = parseFloat(variables[parts[2]] ?? 1);
            variables[parts[3]] = b !== 0 ? a / b : "Ошибка: деление на 0";
          } else if (cmd === "СЛУЧАЙНО") {
            let a = parseInt(variables[parts[1]] ?? parts[1]);
            let b = parseInt(variables[parts[2]] ?? parts[2]);
            variables[parts[3]] = Math.floor(Math.random() * (b - a + 1)) + a;
          }
        } catch (e) {
          outputDiv.innerHTML += "Ошибка: " + e.message + "<br>";
        }
      }
    }

    function runCode() {
      const lines = \`${escapeHtml(code)}\`.split("\\n");
      for (let line of lines) {
        renderLine(line);
      }
    }

    runCode();
    <\/script>
  `;
  win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>AKANCODE Site</title></head><body><pre></pre>${script}</body></html>`);
}
</script>

</body>
</html>